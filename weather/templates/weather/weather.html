{% extends "base.html" %}
{% load static %}

{% block title %}Rutea — Dashboard{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'weather/css/weather.css' %}?v=8">
{% endblock %}

{% block content %}
  <!-- User prefs for JS -->
  <div id="userPrefs" class="hidden"
    data-metric="{% if user.is_authenticated %}{{ use_metric|yesno:'true,false' }}{% else %}true{% endif %}"
    data-authed="{% if user.is_authenticated %}true{% else %}false{% endif %}"
    {% if home_lat and home_lon %}
    data-home-lat="{{ home_lat }}"
    data-home-lon="{{ home_lon }}"
    data-home-name="{{ home_name }}"
    {% endif %}
  ></div>
  {% if saved_locations_json %}
  <script id="savedLocationsData" type="application/json">{{ saved_locations_json|safe }}</script>
  {% endif %}
  <!-- ===== GREETING (personalised) ===== -->
  {% if user.is_authenticated %}
  <div class="greeting-row" id="greetingRow">
    <div class="greeting-text">
      <span class="greeting-hello" id="greetingHello">Hello,</span>
      <span class="greeting-name">{{ user_first_name }}</span>
    </div>
    {% if primary_activity %}
    <div class="greeting-primary" id="greetingPrimary" data-slug="{{ primary_activity.slug }}">
      <i data-lucide="{{ primary_activity.icon }}" class="greeting-primary-icon"></i>
      <span class="greeting-primary-name">{{ primary_activity.name }}</span>
      <span class="greeting-primary-score" id="primaryScoreBadge">--</span>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- ===== SEARCH BAR (weather-specific) ===== -->
  <div class="weather-search">
    <div class="search-wrapper">
      <i data-lucide="search" class="search-icon"></i>
      <input type="text" class="search-input" id="searchInput" placeholder="Search city..." autocomplete="off">
      <div class="search-results" id="searchResults"></div>
    </div>
    <button class="btn-location" id="btnLocation">
      <i data-lucide="map-pin" class="btn-icon"></i>
      <span class="btn-location-text">My Location</span>
    </button>
  </div>

  <!-- ===== SAVED LOCATIONS BAR ===== -->
  {% if user.is_authenticated %}
  <div class="saved-bar" id="savedBar"></div>
  {% endif %}

  <!-- ===== WELCOME ===== -->
  <div class="state-message" id="welcomeState">
    <div class="state-icon"><i data-lucide="globe"></i></div>
    {% if user.is_authenticated %}
    <h2>Where are you heading?</h2>
    <p>Search a city or tap My Location to see conditions and activity scores.</p>
    {% else %}
    <h2>Check the forecast</h2>
    <p>Search for any city worldwide or allow location access to get your local weather instantly.</p>
    {% endif %}
  </div>

  <!-- ===== LOADING ===== -->
  <div class="state-message" id="loadingState" style="display:none;">
    <div class="spinner"></div>
    <h2>Fetching weather data</h2>
    <p>Retrieving conditions and forecast...</p>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div class="dashboard" id="dashboard">

    <!-- Hero -->
    <div class="hero-card card" id="heroCard">
      <div class="hero-lava">
        <span class="lava-blob blob-1"></span>
        <span class="lava-blob blob-2"></span>
        <span class="lava-blob blob-3"></span>
      </div>
      <div class="hero-left">
        <div class="hero-location">
          <div class="hero-city" id="cityName">--</div>
          <div class="hero-country" id="countryName"></div>
        </div>
        <div class="hero-condition" id="currentCondition">--</div>
        <div class="hero-temp-row">
          <div class="hero-icon" id="currentIcon"></div>
          <div class="hero-temp" id="currentTemp">--<span class="hero-temp-unit">&deg;C</span></div>
        </div>
      </div>
      <div class="hero-right">
        <div class="clock-label">Local Time</div>
        <div class="clock-time" id="clockTime">--:--</div>
        <div class="clock-date" id="clockDate"></div>
        <button class="btn-share" id="btnShare" title="Share weather">
          <i data-lucide="share-2"></i>
        </button>
      </div>
    </div>

    <!-- Smart tip -->
    <div class="smart-tip" id="smartTip" style="display:none;">
      <i data-lucide="sparkles" class="smart-tip-icon"></i>
      <span class="smart-tip-text" id="smartTipText"></span>
    </div>

    <!-- Best Time Widget (personalised, shown to logged-in users with a primary activity) -->
    {% if primary_activity %}
    <div class="best-time-card card" id="bestTimeCard" style="display:none;">
      <div class="best-time-left">
        <div class="best-time-label">Best time for <strong>{{ primary_activity.name }}</strong></div>
        <div class="best-time-value" id="bestTimeValue">--</div>
      </div>
      <div class="best-time-score" id="bestTimeScore">
        <div class="best-time-ring" id="bestTimeRing">
          <svg viewBox="0 0 36 36">
            <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
            <path class="ring-fill" id="bestTimeRingFill" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          </svg>
          <span class="ring-text" id="bestTimeRingText">--</span>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Activity Scores -->
    <div class="scores-section" id="scoresSection" style="display:none;">
      <div class="section-title">Activity Scores</div>
      <div class="scores-grid" id="scoresGrid"></div>
    </div>

    <!-- Weekly Activity Outlook (primary activity) -->
    {% if primary_activity %}
    <div class="weekly-outlook" id="weeklyOutlook" style="display:none;">
      <div class="section-title">{{ primary_activity.name }} — This Week</div>
      <div class="weekly-dots" id="weeklyDots"></div>
    </div>
    {% endif %}

    <!-- Detail cards -->
    <div class="details-grid" id="detailsGrid">
      <div class="detail-card card">
        <div class="detail-header">
          <span class="detail-icon"><i data-lucide="thermometer"></i></span>
          <span class="detail-label">Feels like</span>
        </div>
        <div class="detail-value" id="feelsLike">--</div>
      </div>
      <div class="detail-card card">
        <div class="detail-header">
          <span class="detail-icon"><i data-lucide="droplets"></i></span>
          <span class="detail-label">Humidity</span>
        </div>
        <div class="detail-value" id="humidity">--</div>
      </div>
      <div class="detail-card card">
        <div class="detail-header">
          <span class="detail-icon"><i data-lucide="wind"></i></span>
          <span class="detail-label">Wind</span>
        </div>
        <div class="detail-value" id="windSpeed">--</div>
        <div class="detail-sub" id="windDir"></div>
      </div>
      <div class="detail-card card">
        <div class="detail-header">
          <span class="detail-icon"><i data-lucide="sun"></i></span>
          <span class="detail-label">UV Index</span>
        </div>
        <div class="detail-value" id="uvIndex">--</div>
        <div class="detail-sub" id="uvLabel"></div>
      </div>
      <div class="detail-card card">
        <div class="detail-header">
          <span class="detail-icon"><i data-lucide="gauge"></i></span>
          <span class="detail-label">Pressure</span>
        </div>
        <div class="detail-value" id="pressure">--</div>
      </div>
      <div class="detail-card card">
        <div class="detail-header">
          <span class="detail-icon"><i data-lucide="flag"></i></span>
          <span class="detail-label">Max Wind</span>
        </div>
        <div class="detail-value" id="maxWind">--</div>
      </div>
    </div>

    <!-- Sunrise / Sunset -->
    <div class="sun-card-wrap">
      <div class="sun-card card">
        <div class="sun-icon"><i data-lucide="sunrise"></i></div>
        <div class="sun-info">
          <div class="sun-label">Sunrise</div>
          <div class="sun-time" id="sunrise">--:--</div>
        </div>
      </div>
      <div class="sun-card card">
        <div class="sun-icon"><i data-lucide="sunset"></i></div>
        <div class="sun-info">
          <div class="sun-label">Sunset</div>
          <div class="sun-time" id="sunset">--:--</div>
        </div>
      </div>
    </div>

    <!-- Hourly forecast -->
    <div class="hourly-section">
      <div class="section-title">Next 24 Hours</div>
      <div class="hourly-card card">
        <div class="hourly-scroll" id="hourlyScroll"></div>
      </div>
    </div>

    <!-- 7-day forecast -->
    <div class="forecast-section">
      <div class="section-title">7-Day Forecast</div>
      <div class="forecast-card card" id="forecastList"></div>
    </div>

  </div><!-- /dashboard -->
{% endblock %}

{% block extra_js %}
  <script type="module" src="{% static 'weather/js/app.js' %}?v=8"></script>
{% endblock %}
